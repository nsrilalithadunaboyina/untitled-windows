<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd 
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd">
<sub-flow name="getCustomersMissingSFAccountId" doc:id="44a96101-8ea6-426a-9897-cda01bfc8b5e" doc:description="This flow retrieves all the customers whose Uf_SFAccountId is null">
<logger level="INFO" doc:name="Get Customer List" doc:id="f8035905-5e02-46aa-8ddd-e6894dca95cb" message="#[flow.name] :: Start :: #[now()] :: Payload :: #[payload] "/>
		<ee:transform doc:name="get All Customers Query" doc:id="e05bffbc-47b1-497f-8e00-528b6d6de0dd" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="query" ><![CDATA[%dw 2.0
output application/json
---
Mule::p('queries.customer.missingSFID')]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		
		<flow-ref doc:name="Flow Reference" doc:id="3db5382f-6548-42ec-8df7-bdaea4ac43b5" name="dbOperations-selectQuery"/>
		
		<choice doc:name="Check if customers found" doc:id="customers-found-check">
		    <when expression="#[(payload != null) and (sizeOf(payload) &gt; 0)]">
		        <ee:transform doc:name="Transform Message" doc:id="86a7d2a8-6d84-432f-b86e-9bfaf88b5daa">
		            <ee:message>
		                <ee:set-payload><![CDATA[%dw 2.0
		output application/json
		--- 
		{
		  customers: payload
		}]]></ee:set-payload>
		            </ee:message>
		        </ee:transform>
		    </when>
		    <otherwise>
		        <ee:transform doc:name="No customers found response" doc:id="no-customers-found">
		            <ee:message>
		                <ee:set-payload><![CDATA[%dw 2.0
		output application/json
		---
		{
		  customers: []
		}]]></ee:set-payload>
		            </ee:message>
		        </ee:transform>
		    </otherwise>
		</choice>
		
<logger level="INFO" doc:name="Logger" doc:id="f318b0d3-0edd-40a8-94b0-4bf0965fbe76" message="#[flow.name] :: End :: #[now()] :: Payload :: #[payload] "/>
</sub-flow>
<sub-flow name="getCustomerDetailsById" doc:id="182f9571-95d9-4183-acd6-3603c7b92eea">
<logger level="INFO" doc:name="Get Customer List" doc:id="f2304b13-cf6b-4205-962a-57055648240b" message="#[flow.name] :: Start :: #[now()] :: Payload :: #[payload] "/>
<logger level="INFO" doc:name="Logger" doc:id="5485f658-0960-4b5c-a089-c899ea8d95d9" message="Before fetching the cutomer details for the customer :: #[vars.Id]"/>
<ee:transform doc:name="getCustomerId Query" doc:id="a0a2bdcc-827e-4c8d-a2ca-38fe2474236d" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/java
---
{ query: Mule::p('queries.customer.customerByID'),
  params: {
  	Id: vars.Id
  }
 }]]></ee:set-payload>
			</ee:message>
			<ee:variables >
			</ee:variables>
		</ee:transform>
		<flow-ref doc:name="Flow Reference" doc:id="75f3c6b7-9913-4010-a86d-b46b67886689" name="dbOperations-selectQueryWithParams"/>
		
<choice doc:name="Check if customer exists" doc:id="customer-exists-check">
    <when expression="#[(payload != null) and (sizeOf(payload) &gt; 0)]">
        <ee:transform doc:name="Transform Message" doc:id="fef37a1b-acff-465d-bfa2-f343a9fcafd0">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
--- 
payload[0] ]]>
                </ee:set-payload>
            </ee:message>
        </ee:transform>
    </when>
    <otherwise>
        <ee:transform doc:name="Customer not found response" doc:id="customer-not-found">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  correlationId: uuid(),
  message: "Customer not found",
  errorType: "NOT_FOUND",
  description: "No customer found with the specified ID",
  detailedDescription: "The customer ID provided does not exist in the system",
  timestamp: now(),
  path: attributes.requestPath default "",
  method: attributes.httpMethod default "",
  customerId: vars.Id
}]]></ee:set-payload>
            </ee:message>
            <ee:variables>
                <ee:set-variable variableName="httpStatus">404</ee:set-variable>
            </ee:variables>
        </ee:transform>
    </otherwise>
</choice>
<logger level="INFO" doc:name="Logger" doc:id="1140bff3-4d2d-4a47-bac2-c09ff3c5bcf5" message="#[flow.name] :: End :: #[now()] :: Payload :: #[payload] "/>
</sub-flow>
<sub-flow name="UpdateCustomerDetailsById" doc:id="4bd17a00-2bdd-4621-ad86-80cf174d4a91">
<logger level="INFO" doc:name="UpdateCustomer" doc:id="d990e5ae-002e-4785-851c-e7dde41be78d" message='Update Customer-Started: #[now()] ::  Customer ID ::#[vars.Id] :: Payload :: #[payload]'/>
<ee:transform doc:name="Transform" doc:id="be507dfb-6482-49b0-8424-058bb5f1c43b" >
      <ee:message >
        <ee:set-payload doc:name="Set payload" doc:id="1f7ee9ec-66fa-47d9-8157-39be38d5205c" ><![CDATA[%dw 2.0
output application/json
---
Mule::p('queries.customer.updateCustomerSFAccountId_1') ++ payload.site_ref ++ "',@Infobar = 'info'; DECLARE @rowsAffected INT; " ++ Mule::p('queries.customer.updateCustomerSFAccountId_2')  ++ payload.Uf_SFAccountID ++ "' WHERE cust_seq =0 and site_ref='" ++ payload.site_ref ++ "' AND cust_num = '" ++ attributes.uriParams.'Id' ++ "';\nSELECT @rowsAffected AS rowsAffected;"]]></ee:set-payload>
      </ee:message>
    </ee:transform>
		<try doc:name="Try" doc:id="5c4088fb-e7f7-4f57-a7f7-b009b7a2d63b" >
			<!-- [ACB] <until-successful maxRetries="1" doc:name="Until Successful" doc:id="05874043-fa93-445b-92ff-6542405ecbd9" millisBetweenRetries="3000">
<db:execute-script doc:name="Execute script" doc:id="8239a533-66f4-43eb-a887-591542aff8ea" config-ref="Database_Config">
			<db:sql ><![CDATA[#[payload]]]></db:sql>
		</db:execute-script>
		</until-successful> [ACB] -->
            <flow-ref doc:name="Update_Customer" doc:id="5c4088fb-e7f7-4f57-a7f7-b109b7a2d63b" name="dbOperations-executeScript"/>
			  <ee:transform doc:name="Transform Message" doc:id="e95736a8-ea95-4c39-86b9-566640b78228">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  "status": "Customer updated successfully"
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
			<error-handler>
				<on-error-continue doc:name="Handle Update Failure" doc:id="handle-update-failure" enableNotifications="true" logException="true" type="APP:UPDATE_FAILED">
				<logger level="ERROR" doc:name="Log Update Failure" doc:id="log-update-failure" message="Service order update failed: #[error.description]"/>
				<ee:transform doc:name="Transform Error Response" doc:id="transform-error-response">
					<ee:message>
					<ee:set-payload><![CDATA[%dw 2.0
			output application/json
			---
			{
			correlationId: uuid(),
			message: "Customer update failed",
			errorType: "UPDATE_FAILED",
			description: "Failed to update Customer in the database",
			detailedDescription: error.description,
			timestamp: now(),
			serviceOrderId: attributes.uriParams.'Id' default "",
			path: attributes.requestPath default "",
			method: attributes.httpMethod default ""
			}]]></ee:set-payload>
					</ee:message>
					<ee:variables>
					<ee:set-variable variableName="httpStatus">400</ee:set-variable>
					</ee:variables>
				</ee:transform>
				</on-error-continue>
			</error-handler>
		</try>
		<logger level="DEBUG" doc:name="Logger1" doc:id="d638d440-d94d-4648-adef-7840ce9e2d9c" message="#[flow.name] :: End :: #[now()] :: Payload :: #[payload] " />
</sub-flow>
</mule>
